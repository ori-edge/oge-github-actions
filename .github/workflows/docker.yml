name: Docker build and push

on:
  workflow_call:
    inputs:
      chartPath:
        description: "helm Chart.yaml path e.g. charts/yourapp/Chart.yaml"
        required: true
        type: string
      dockerRegistry:
        description: "name of the docker registry"
        required: false
        default: "quay.io"
        type: string
      dockerRepo:
        description: "name of the docker repository"
        required: false
        default: "oriedge"
        type: string
      imageName:
        description: "name of the docker image to be built"
        required: true
        type: string
      buildContext:
        description: "docker build context in case Dockerfile"
        default: "."
        required: false
        type: string
    secrets:
      REGISTRY_USERNAME:
        description: "docker registry username"
        required: false
      REGISTRY_PASSWORD:
        description: "docker registry password"
        required: false

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get helm chart version
        run: echo "CHART_VERSION=$(grep '^version:' ${{ inputs.chartPath }} | cut -d ":" -f2 | tr -d ' ')" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to quay.io Container Registry
        uses: docker/login-action@v1
        with:
          registry: ${{ inputs.dockerRegistry }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push image
        uses: docker/build-push-action@v2
        with:
          context: ${{ inputs.buildContext }}
          build-args: version=${{ env.CHART_VERSION }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ inputs.dockerRegistry }}/${{ inputs.dockerRepo }}/${{ inputs.imageName }}:${{ env.CHART_VERSION }}
